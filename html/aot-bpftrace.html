<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Ahead-Of-Time compiled bpftrace programs</title>
  <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <link rel="stylesheet" href="css/pandoc.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Ahead-Of-Time compiled bpftrace programs</h1>
</header>
<p>This page serves as a design document for bpftrace AOT compilation support. Design is currently a work-in-progress and will be (somewhat) regularly updated.</p>
<h2 id="overall-design">Overall design</h2>
<ul>
<li>Ship a fully executable runtime shim with bpftrace</li>
<li>When compiling a AOT bpftrace program:
<ul>
<li>Build the metadata</li>
<li>Build the bytecode</li>
<li>Make a copy of runtime shim and store metadata + bytecode into a special ELF section (this is the final executable)</li>
</ul></li>
<li>When the shim runs, it knows to look inside itself for the metadata + bytecode and start execution</li>
</ul>
<h2 id="current-architecture">Current architecture</h2>
<p><img src="../examples/aot-bpftrace/old-architecture.png" style="width:100.0%" /></p>
<h2 id="proposed-architecture">Proposed architecture</h2>
<p>AST passes:</p>
<p><img src="../examples/aot-bpftrace/old-passes.png" /> =&gt; <img src="../examples/aot-bpftrace/new-passes.png" /></p>
<p>Simplified architecture (some unchanged parts omitted):</p>
<p><img src="../examples/aot-bpftrace/new-architecture.png" style="width:100.0%" /></p>
<p>Key:</p>
<ul>
<li>Green -&gt; added to all codepaths</li>
<li>Orange -&gt; added to AOT compile codepath</li>
</ul>
<hr />
<p>AOT execution:</p>
<p><img src="../examples/aot-bpftrace/aot-execution.png" /></p>
<h2 id="unsolved-problems">Unsolved problems</h2>
<ul>
<li><code>CodegenLLVM</code> relies on runtime state in <code>BPFtrace</code>
<ul>
<li>Async argument IDs (<code>printf_id_</code>, <code>cat_id_</code>, <code>etc</code>)</li>
<li>Codegen for <code>elapsed</code> embeds map FD</li>
<li>Positional parameters are hardcoded into bytecode</li>
<li>Any others?</li>
</ul></li>
<li>Some features rely on per-host properties
<ul>
<li><code>kaddr()</code></li>
<li><code>uaddr()</code></li>
<li><code>cgroupid()</code></li>
<li>Any <code>-p PID</code> based feature
<ul>
<li>watchpoints, certain USDT features</li>
</ul></li>
<li>Any others?</li>
</ul></li>
<li>Generate CO-RE field access instructions
<ul>
<li>Will need to generate some kind of access identifier (eg. <code>1:0:3:4</code>)</li>
</ul></li>
<li>Runtime still use bcc (eg. symbolization) and bcc links LLVM</li>
</ul>
<h2 id="notes">Notes</h2>
<ul>
<li>Can save metadata into special ELF section; fortunately we don’t need to worry about compatability as an AOT executable is hermetic</li>
<li>Must ship a stubbed (no bytecode) AOT executable that knows to look inside itself for bytecode
<ul>
<li>Should be simple enough with cmake</li>
</ul></li>
<li>Can create a ReadOnlyData abstraction that holds data that is only known at runtime but progs need to access too (<code>elapsed</code> builtin, positional params, etc.) and is backed by multiple maps (for different data types)</li>
<li>Will need to relocate pseudo-map-FDs at runtime to FDs of created maps (see BPF_PSEUDO_MAP_FD in libbpf)</li>
<li>Punting everything we can to libbpf seems like a prudent decision
<ul>
<li>Map creation, map FD fixup, extern symbol resolution</li>
<li>Reason is that some new bpf helpers (bpf_per_cpu_ptr()) require BTF ID to be in immediate operand of certain instructions, and we don’t really want to redo/maintain that stuff in bpftrace</li>
</ul></li>
</ul>
<h2 id="future-goals">Future goals</h2>
<ul>
<li>User can select features to enable in codegen
<ul>
<li>eg. “tell codegen that the target host has XXX feature”</li>
</ul></li>
<li>Emitted bytecode takes advantage of CO-RE to be more compatible on other hosts</li>
</ul>
</body>
</html>
