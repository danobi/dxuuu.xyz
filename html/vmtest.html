<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>vmtest: Run your tests in virtual machines</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="css/pandoc.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">vmtest: Run your tests in virtual machines</h1>
</header>
<h2 id="motivation">Motivation</h2>
<p>Systems software that depend on specific kernel or host properties
often contains logic to gate functionality based on what features are
available at runtime. This necessarily begs the question: how do you
test platform specific logic? Mocks can help, but they come with their
own set of tradeoffs. At the end of the day, there is no substitute for
actually running your code.</p>
<p>eBPF (BPF) is somewhat of an extreme example because of how fast
development occurs in that ecosystem. Most, if not all, BPF features are
baked into the kernel, meaning that any non-trivial BPF-powered
application heavily depends on kernel version. Since I do quite a bit of
BPF development, the rest of this post is as a result, BPF focused.
Despite that, keep in mind that all proposed techniques/solutions are
quite general and can be applied to other domains.</p>
<h2 id="background">Background</h2>
<p>Paradoxicaly enough, despite BPF being my motivation for
<code>vmtest</code>, BPF has excellent support for testing through <a
href="https://github.com/torvalds/linux/blob/16a8829130ca22666ac6236178a6233208d425c3/include/uapi/linux/bpf.h#L332-L368"><code>BPF_PROG_RUN</code></a>.</p>
<p>BPF programs are normally attached to a hook and only executed when
when the hook is reached by the kernel. <code>BPF_PROG_RUN</code>, on
the other hand, allows userspace to run BPF programs in “freestanding”
mode. More precisely, it allows userspace to both provide the input
context, run the program on demand, and collect the program’s return
value (among a few other things).</p>
<p>Contrast this with something like <code>iptables</code> where it
takes considerably more setup (network namespaces, fake network devices,
traffic generators, etc.) to get automated tests. And even after all of
that, it’s more of an integration test than a true unit test.</p>
<p>Basically given <code>BPF_PROG_RUN</code>, all that’s left to solve
is how to control the kernel your tests run on top of.</p>
<h2 id="goals">Goals</h2>
<p>The primary goal is to <strong>create infrastructure that runs code
inside target kernels</strong>. Along the way we may solve other
problems or enable other use cases, but our primary goal will help
inform our design decisions.</p>
<p>In addition, the following are design ideas (in decreasing order of
importance) that will help inform our decisions:</p>
<ol type="1">
<li>Make it reusable: <code>vmtest</code> should be as generic as
possible and adoptable across projects in different domains.</li>
<li>Make it work in CI: <code>vmtest</code> should be able to run in
Github Actions. Supporting other providers would be even better.</li>
<li>Make it simple: defaults should “just work”. Any configurables
should be unavoidable to expose.</li>
</ol>
<h2 id="solution">Solution</h2>
<p>Our solution is two-fold: <a
href="https://github.com/danobi/vmtest"><code>vmtest</code></a> and <a
href="https://github.com/danobi/vmtest-action"><code>vmtest-action</code></a>.</p>
<p><code>vmtest</code> is the workhorse binary and contains all the
logic to orchestrate <code>qemu</code> on the root host and
<code>qemu-guest-agent</code> inside the guest VM. Among other things,
it maps the running userspace into the guest VM as its rootfs. The end
result is that your host’s userspace “just runs”, except the kernel it’s
running under is different. The binary also supports a handful of
nice-to-have things such as a standard unix interface, a terminal user
interface, and support for multiple targets through a configuration
file.</p>
<p><code>vmtest-action</code> is a Github Actions wrapper (ie. a
singular <a
href="https://docs.github.com/en/actions/creating-actions/about-custom-actions">Github
Action</a>) that downloads/installs <code>vmtest</code> as well as its
runtime dependencies. The action exposes a subset of the features
<code>vmtest</code> supports but at the same time adds a few
conveniences (such as URL asset downloads) – effectively tailoring
<code>vmtest</code> to CI usage.</p>
<p>The two part solution helps separate concerns but also allows for
novel uses cases such iterating on kernel changes using the
<code>vmtest</code> binary.</p>
<h2 id="multi-target-example">Multi-target example</h2>
<p>Consider the following <code>vmtest.toml</code> configuration:</p>
<pre><code>[[target]]
name = &quot;check if kernel is 6.2&quot;
kernel = &quot;./bzImage-v6.2&quot;
command = &quot;/bin/bash -c &#39;uname -r | grep -e ^6.2.0$&#39;&quot;

[[target]]
name = &quot;check if kernel is 6.1&quot;
kernel = &quot;./bzImage-v6.2&quot;
command = &quot;/bin/bash -c &#39;uname -r; uname -r | grep -e ^6.1.0$&#39;&quot;</code></pre>
<p>The above has two targets: the first target checks if the running
kernel is v6.2 and the second checks if the running kernel is v6.1.
Since they’re both going to run under a v6.2 kernel, only the first
target should succeed. Carefully note here that we do not define a
rootfs or run install scripts to get access to <code>bash</code> and
<code>coreutils</code> – the entire running userspace on your host is
shared into the VM.</p>
<p>This is what a run looks like:</p>
<p><img src="../examples/vmtest/demo.gif" style="width:100.0%" /></p>
<p>Note that our second target fails as expected.</p>
<h2 id="ci-example">CI example</h2>
<p>Now pretend you have a bog standard Github Actions (GHA) workflow. It
has fairly standard steps – for example installing dependencies, build
configuration, and executing a test runner. This workflow implicitly
uses the kernel the GHA runner’s kernel. Perhaps it was new enough for a
while but now it’s too old and you need to find a way to run your tests
against a matrix of newer kernels.</p>
<p><code>vmtest-action</code> would satisfy your needs with the
following diff:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode diff"><code class="sourceCode diff"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">diff --git a/.github/workflows/ci.yml b/.github/workflows/ci.yml</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>index 4b1d68f..d62fed9 100644</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="dt">--- a/.github/workflows/ci.yml</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="dt">+++ b/.github/workflows/ci.yml</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -7,6 +7,16 @@ on:</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a> jobs:</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>   build:</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="va">+    strategy:</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="va">+      matrix:</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="va">+        kernel:</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="va">+          - name: v6.0</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="va">+            url: https://github.com/danobi/vmtest/releases/download/test_assets/bzImage-v6.0</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="va">+          - name: v6.1</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="va">+            url: https://github.com/danobi/vmtest/releases/download/test_assets/bzImage-v6.1</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="va">+          - name: v6.2</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="va">+            url: https://github.com/danobi/vmtest/releases/download/test_assets/bzImage-v6.2</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>     runs-on: ubuntu-latest</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>     steps:</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>     - uses: actions/checkout@v3</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="dt">@@ -21,5 +31,8 @@ jobs:</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>         ninja -C build</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>     - name: Run</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="st">-      run: |</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="st">-        ./build/vmtest-action-demo</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="va">+      uses: danobi/vmtest-action@master</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="va">+      with:</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="va">+        name: ${{ matrix.kernel.name }}</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a><span class="va">+        kernel_url: ${{ matrix.kernel.url }}</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a><span class="va">+        command: ${{ github.workspace}}/build/vmtest-action-demo</span></span></code></pre></div>
<p>Note how the dependency install, configure, and build steps are being
run <em>outside</em> the VM. This is desirable b/c anything running
inside the VM is liable to be slower in the event emulation is
necessary.</p>
<h2 id="implementation">Implementation</h2>
<p><img src="../examples/vmtest/architecture.png"
style="width:100.0%" /></p>
<p>The first big idea is that vmtest tries to orchestrate everything
through QEMU’s programmable interfaces, namely the QEMU machine protocol
(QMP) for orchestrating QEMU and qemu-guest-agent (which also uses QMP
under the hood) for running things inside the guest VM. Both interfaces
use a unix domain socket for transport.</p>
<p>Using QEMU’s programmable interfaces is probably the only novel
contribution we make to this problem space. The other ideas (even the
name) are shamelessly borrowed from other folk’s earlier explorations.
This contribution, however, makes developing and extending
<code>vmtest</code> a much saner and pleasant experience over things
like triple-escaping shell commands. qemu-guest-agent alone gives us a
clean out-of-band mechanism (so not requiring networking or SSH) to run
commands inside the guest.</p>
<p>The second big idea is that we use 9p filesystems to share the host
filesystem inside the guest. This is useful so that vmtest targets can
import/export data in bulk without having to specify what to copy. In a
kernel target, vmtest exports two volumes: <code>/mnt/vmtest</code> and
the root filesystem. The first volume is the directory rooted by
<code>vmtest.toml</code> mounted read/write. The latter export
effectively gives the guest VM the same userspace environment as the
host, except we mount it read-only so the guest cannot do too much
damage to the host.</p>
<h2 id="conclusion">Conclusion</h2>
<p><code>vmtest</code> is only just getting started. By the time it goes
into maintenance mode, there should be no excuse to be missing VM-based
testing from your development workflows.</p>
</body>
</html>
