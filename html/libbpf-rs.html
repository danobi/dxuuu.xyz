<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>libbpf-rs: eBPF for the Rust ecosystem</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="css/pandoc.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">libbpf-rs: eBPF for the Rust ecosystem</h1>
</header>
<h3 id="background">Background</h3>
<p>eBPF (BPF) programs have traditionally been written using <a href="https://github.com/iovisor/bcc">BPF compiler collection</a> (BCC). The application would then call into BCC using the C++ or Python bindings. BCC has an “on-the-fly” model, meaning BPF programs are compiled during runtime on production host. While this works, there are drawbacks:</p>
<ol type="1">
<li><p>Every production machine needs kernel headers installed. These can get out of sync and can be missing internal headers.</p></li>
<li><p>LLVM/clang is heavyweight in both binary size and resource consumption. This is because BCC needs to compile the BPF program (written in C) down to BPF bytecode the kernel can understand.</p></li>
<li><p>End results can vary with kernel version and configuration. The BPF program can and will change depending on the host it’s running on.</p></li>
</ol>
<p>This diagram illustrates BCC’s compilation and runtime model:</p>
<p><img src="../examples/libbpf-rs/bcc.svg" style="width:100.0%" /></p>
<h3 id="compile-once-run-everywhere">Compile once run everywhere</h3>
<p><a href="https://facebookmicrosites.github.io/bpf/blog/2020/02/19/bpf-portability-and-co-re.html">Compile once run everywhere</a> (CO-RE) is a development effort that aims to (and does) solve the above issues by enabling ahead of time BPF program compilation. A summary of developments include:</p>
<ul>
<li><p><a href="https://www.kernel.org/doc/html/latest/bpf/btf.html">BPF type format</a> (BTF). You can think of BTF as a very light weight alternative to <a href="https://en.wikipedia.org/wiki/DWARF">DWARF</a>; light enough that you can write a parser in an afternoon. When the kernel is compiled with <code>CONFIG_DEBUG_INFO_BTF=y</code>, the final kernel image contains BTF entries for <strong>all</strong> internal data structures. Type definitions can then be extracted from BTF, obviating the need for kernel headers to be installed.</p></li>
<li><p>Compiler (clang) support for relocatable field accesses. Consider accessing field <code>bar</code> from <code>struct Foo</code>. In BCC’s model, BCC doesn’t need to worry about <code>struct Foo</code>’s structure layout changing. That’s because BCC compiles the program against the installed headers on every target host. This becomes an issue for CO-RE BPF progs. CO-RE BPF progs must have their field accesses relocated so that they reflect the target machine’s structure layouts.</p></li>
<li><p>BPF loader (<a href="https://github.com/libbpf/libbpf">libbpf</a>) support for BPF program fixups. libbpf must “custom-tailor” the BPF program for the target host it’s running on.</p></li>
</ul>
<p>More in-depth documentation as well as user facing APIs is available <a href="https://facebookmicrosites.github.io/bpf/blog/2020/02/19/bpf-portability-and-co-re.html">here</a>.</p>
<p>This diagram illustrates the CO-RE compilation and runtime model:</p>
<p><img src="../examples/libbpf-rs/core.svg" style="width:100.0%" /></p>
<h3 id="enter-rust">Enter Rust</h3>
<p>Why Rust? Rust’s appeal (to systems programmers like myself) is its emphasis on safety without compromising on performance or expressiveness. As such, there are powerful facilities for library designers to build abstractions that resist misuse. This, coupled with the kernel’s guarantee that a verified BPF program (modulo bugs) can never crash, hang or interfere with the kernel negatively, makes Rust + BPF a very attractive combination.</p>
<p><a href="https://github.com/libbpf/libbpf-rs">libbpf-rs</a> provides safe (w.r.t. Rust’s <code>unsafe</code> keyword) bindings to libbpf. On top of that, libbpf-rs is designed such that if your code can compile, you’re almost certainly using the library correctly. Much of that guarantee comes from liberal use of newtype and builder patterns.</p>
<p>libbpf-cargo is a <a href="https://doc.rust-lang.org/cargo/">cargo</a> plugin that integrates with cargo workflows Rust programmers are already familiar with.</p>
<p>Together, libbpf-rs and libbpf-cargo provide CO-RE support in the Rust ecosystem.</p>
<h3 id="rust-skeleton">Rust skeleton</h3>
<p>NOTE: if you want to skip ahead and browse the unabridged example, look <a href="https://github.com/libbpf/libbpf-rs/tree/master/examples/runqslower">here</a>.</p>
<p>BPF skeletons started out as an alternative interface to libbpf. It’s goal was to simplify and reduce boilerplate when developing BPF applications. In fact, it was so successful that it’s now the recommended interface. Naturally, libbpf-rs supports Rust BPF skeletons.</p>
<p>Given a BPF object file (eg <code>myobj.bpf.o</code>), <code>cargo libbpf gen</code> can generate a Rust skeleton for your object file. Consider <a href="https://github.com/iovisor/bcc/blob/a55192b26d0a9294ed4e0bcd8170225dad62dd61/tools/runqslower_example.txt">runqslower</a>: a prototypical BPF application. <code>runqslower</code> shows high latency scheduling times between tasks being ready to run and them running on CPU after that. Below is an abridged copy of <code>runqslower.bpf.c</code>, the BPF program bits:</p>
<div class="sourceCode" id="function"><pre class="sourceCode c"><code class="sourceCode c"><span id="function-1"><a href="#function-1" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">volatile</span> __u64 min_us = <span class="dv">0</span>;</span>
<span id="function-2"><a href="#function-2" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">volatile</span> pid_t targ_pid = <span class="dv">0</span>;</span>
<span id="function-3"><a href="#function-3" aria-hidden="true" tabindex="-1"></a><span class="dt">const</span> <span class="dt">volatile</span> pid_t targ_tgid = <span class="dv">0</span>;</span>
<span id="function-4"><a href="#function-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-5"><a href="#function-5" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> {</span>
<span id="function-6"><a href="#function-6" aria-hidden="true" tabindex="-1"></a>    __uint(type, BPF_MAP_TYPE_HASH);</span>
<span id="function-7"><a href="#function-7" aria-hidden="true" tabindex="-1"></a>    __uint(max_entries, <span class="dv">10240</span>);</span>
<span id="function-8"><a href="#function-8" aria-hidden="true" tabindex="-1"></a>    __type(key, u32);</span>
<span id="function-9"><a href="#function-9" aria-hidden="true" tabindex="-1"></a>    __type(value, u64);</span>
<span id="function-10"><a href="#function-10" aria-hidden="true" tabindex="-1"></a>} start SEC(<span class="st">&quot;.maps&quot;</span>);</span>
<span id="function-11"><a href="#function-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-12"><a href="#function-12" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> {</span>
<span id="function-13"><a href="#function-13" aria-hidden="true" tabindex="-1"></a>    __uint(type, BPF_MAP_TYPE_PERF_EVENT_ARRAY);</span>
<span id="function-14"><a href="#function-14" aria-hidden="true" tabindex="-1"></a>    __uint(key_size, <span class="kw">sizeof</span>(u32));</span>
<span id="function-15"><a href="#function-15" aria-hidden="true" tabindex="-1"></a>    __uint(value_size, <span class="kw">sizeof</span>(u32));</span>
<span id="function-16"><a href="#function-16" aria-hidden="true" tabindex="-1"></a>} events SEC(<span class="st">&quot;.maps&quot;</span>);</span>
<span id="function-17"><a href="#function-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-18"><a href="#function-18" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> __always_inline <span class="dt">int</span> trace_enqueue(u32 tgid, u32 pid);</span>
<span id="function-19"><a href="#function-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-20"><a href="#function-20" aria-hidden="true" tabindex="-1"></a>SEC(<span class="st">&quot;tp_btf/sched_wakeup&quot;</span>)</span>
<span id="function-21"><a href="#function-21" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> handle__sched_wakeup(u64 *ctx);</span>
<span id="function-22"><a href="#function-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-23"><a href="#function-23" aria-hidden="true" tabindex="-1"></a>SEC(<span class="st">&quot;tp_btf/sched_wakeup_new&quot;</span>)</span>
<span id="function-24"><a href="#function-24" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> handle__sched_wakeup_new(u64 *ctx);</span>
<span id="function-25"><a href="#function-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-26"><a href="#function-26" aria-hidden="true" tabindex="-1"></a>SEC(<span class="st">&quot;tp_btf/sched_switch&quot;</span>)</span>
<span id="function-27"><a href="#function-27" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> handle__sched_switch(u64 *ctx);</span></code></pre></div>
<p>As you can see, the object has 3 global variables (<code>min_us</code>, <code>targ_pid</code>, <code>targ_tgid</code>), 2 maps (<code>start</code>, <code>events</code>), and 3 programs (<code>handle__sched_wakeup</code>, <code>handle__sched_wakeup_new</code>, <code>handle__sched_switch</code>).</p>
<p>To compile the object:</p>
<pre><code>$ cd $RUST_PROJECT_ROOT

$ # Program sources must be placed in `src/bpf`
$ find . -name runqslower.bpf.c
./src/bpf/runqslower.bpf.c

$ # If you haven&#39;t already
$ cargo install libbpf-cargo

$ cargo libbpf build</code></pre>
<p>To view what a generated skeleton would look like:</p>
<pre><code>$ cargo libbpf gen --object target/bpf/runqslower.bpf.o
[...]</code></pre>
<p>Below is an abridged skeleton:</p>
<div class="sourceCode" id="function"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="function-1"><a href="#function-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> RunqslowerSkelBuilder <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span>
<span id="function-2"><a href="#function-2" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> RunqslowerSkelBuilder <span class="op">{</span></span>
<span id="function-3"><a href="#function-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> open(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="pp">libbpf_rs::</span><span class="dt">Result</span><span class="op">&lt;</span>OpenRunqslowerSkel<span class="op">&gt;</span></span>
<span id="function-4"><a href="#function-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="function-5"><a href="#function-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-6"><a href="#function-6" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> OpenRunqslowerMaps<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span>
<span id="function-7"><a href="#function-7" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span><span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> OpenRunqslowerMaps<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="function-8"><a href="#function-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> start(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="pp">libbpf_rs::</span>OpenMap</span>
<span id="function-9"><a href="#function-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> events(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="pp">libbpf_rs::</span>OpenMap</span>
<span id="function-10"><a href="#function-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="function-11"><a href="#function-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-12"><a href="#function-12" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> OpenRunqslowerProgs<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span>
<span id="function-13"><a href="#function-13" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span><span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> OpenRunqslowerProgs<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="function-14"><a href="#function-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> handle__sched_wakeup(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="pp">libbpf_rs::</span>OpenProgram</span>
<span id="function-15"><a href="#function-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> handle__sched_wakeup_new(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="pp">libbpf_rs::</span>OpenProgram</span>
<span id="function-16"><a href="#function-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> handle__sched_switch(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="pp">libbpf_rs::</span>OpenProgram</span>
<span id="function-17"><a href="#function-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="function-18"><a href="#function-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-19"><a href="#function-19" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">mod</span> runqslower_rodata_types <span class="op">{</span></span>
<span id="function-20"><a href="#function-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>repr<span class="at">(</span>C<span class="at">)]</span></span>
<span id="function-21"><a href="#function-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> rodata <span class="op">{</span></span>
<span id="function-22"><a href="#function-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> min_us<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="function-23"><a href="#function-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> targ_pid<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="function-24"><a href="#function-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> targ_tgid<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="function-25"><a href="#function-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="function-26"><a href="#function-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="function-27"><a href="#function-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-28"><a href="#function-28" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> OpenRunqslowerSkel<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span>
<span id="function-29"><a href="#function-29" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span><span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> OpenRunqslowerSkel<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="function-30"><a href="#function-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> load(<span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="pp">libbpf_rs::</span><span class="dt">Result</span><span class="op">&lt;</span>RunqslowerSkel<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;&gt;;</span></span>
<span id="function-31"><a href="#function-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> progs(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> OpenRunqslowerProgs<span class="op">;</span></span>
<span id="function-32"><a href="#function-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> maps(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> OpenRunqslowerMaps<span class="op">;</span></span>
<span id="function-33"><a href="#function-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> rodata(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="ot">&#39;a</span> <span class="kw">mut</span> <span class="pp">runqslower_rodata_types::</span>rodata<span class="op">;</span></span>
<span id="function-34"><a href="#function-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="function-35"><a href="#function-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-36"><a href="#function-36" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> RunqslowerMaps<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span> <span class="op">..</span> <span class="op">}</span></span>
<span id="function-37"><a href="#function-37" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span><span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> RunqslowerMaps<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="function-38"><a href="#function-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> start(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="pp">libbpf_rs::</span>Map</span>
<span id="function-39"><a href="#function-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> events(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="pp">libbpf_rs::</span>Map</span>
<span id="function-40"><a href="#function-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="function-41"><a href="#function-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-42"><a href="#function-42" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> RunqslowerProgs<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span>
<span id="function-43"><a href="#function-43" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span><span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> RunqslowerProgs<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="function-44"><a href="#function-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> handle__sched_wakeup(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="pp">libbpf_rs::</span>Program</span>
<span id="function-45"><a href="#function-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> handle__sched_wakeup_new(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="pp">libbpf_rs::</span>Program</span>
<span id="function-46"><a href="#function-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> handle__sched_switch(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="kw">mut</span> <span class="pp">libbpf_rs::</span>Program</span>
<span id="function-47"><a href="#function-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="function-48"><a href="#function-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-49"><a href="#function-49" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> RunqslowerLinks <span class="op">{</span></span>
<span id="function-50"><a href="#function-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> handle__sched_wakeup<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="pp">libbpf_rs::</span>Link<span class="op">&gt;,</span></span>
<span id="function-51"><a href="#function-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> handle__sched_wakeup_new<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="pp">libbpf_rs::</span>Link<span class="op">&gt;,</span></span>
<span id="function-52"><a href="#function-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> handle__sched_switch<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="pp">libbpf_rs::</span>Link<span class="op">&gt;,</span></span>
<span id="function-53"><a href="#function-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="function-54"><a href="#function-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="function-55"><a href="#function-55" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> RunqslowerSkel<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="function-56"><a href="#function-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> links<span class="op">:</span> RunqslowerLinks<span class="op">,</span></span>
<span id="function-57"><a href="#function-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="function-58"><a href="#function-58" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="function-59"><a href="#function-59" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span><span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> RunqslowerSkel<span class="op">&lt;</span><span class="ot">&#39;a</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="function-60"><a href="#function-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> progs(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> RunqslowerProgs</span>
<span id="function-61"><a href="#function-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> maps(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> RunqslowerMaps</span>
<span id="function-62"><a href="#function-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> rodata(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="ot">&#39;a</span> <span class="pp">runqslower_rodata_types::</span>rodata</span>
<span id="function-63"><a href="#function-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> attach(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="pp">libbpf_rs::</span><span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span></span>
<span id="function-64"><a href="#function-64" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note there’s no mention of the <code>runqslower.bpf.o</code> file anymore. That’s because the contents of the object file have been embedded into the skeleton file (using <code>include_bytes!</code> macro). As a result, your application no longer has to worry about shipping all the object files along with your binary(ies).</p>
<p>Also note how for each of the 3 globals, 2 maps, and 3 programs, there are infallible accessorrs. This reduces the number of errors your application can encounter at runtime.</p>
<p>Finally, note the definitions for global data. <code>cargo libbpf gen</code> can read the BTF (that clang generates for the object file) and generate appropriate Rust definitions. Global data is the most convenient way to communicate with BPF programs from userspace.</p>
<p>To set the value of the constant <code>min_us</code>, simply write from userspace:</p>
<div class="sourceCode" id="function"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="function-1"><a href="#function-1" aria-hidden="true" tabindex="-1"></a>open_skel<span class="op">.</span>rodata()<span class="op">.</span>min_us <span class="op">=</span> <span class="dv">42</span><span class="op">;</span>  <span class="co">// The answer to life</span></span></code></pre></div>
<p>Note that <code>OpenRunqslowerSkel::rodata()</code> returns a mutable reference to the read-only data and <code>RunqslowerSkel::rodata()</code> returns immutable reference. That’s because constant values can only be set before the program is loaded into the kernel. Safety at work!</p>
<h3 id="fbcode-support">fbcode support</h3>
<p>XXX remove for open source</p>
<p>Use the <code>rust_bpf_library()</code> buck macro:</p>
<pre><code>load(&quot;//kernel/bpf:defs.bzl&quot;, &quot;rust_bpf_library&quot;)

rust_binary(
    name = &quot;mybinary&quot;,
    src = [&quot;src/main.rs&quot;],
    deps = [&quot;:mybpfprog&quot;],
)

rust_bpf_library(
    name = &quot;mybpfprog&quot;,
    bpf_srcs = [&quot;src/bpf/mybpfprog.bpf.c&quot;],
)</code></pre>
<p><code>rust_bpf_library()</code> generates a Rust skeleton for your BPF object file and places the skeleton into a <code>rust_library()</code> target. The name of the <code>rust_library()</code> target is the name you specify to <code>rust_bpf_library()</code>.</p>
<p>Then in <code>main.rs</code>, use <code>mybpfprog</code> as you would any other Rust library.</p>
<h3 id="conclusion">Conclusion</h3>
<p>If you have questions (you most likely do) about libbpf-rs, please consult the official documentation:</p>
<ul>
<li><a href="https://docs.rs/libbpf-rs/latest/libbpf_rs/index.html">libbpf-rs docs.rs</a></li>
<li><code>cargo libbpf --help</code></li>
<li><a href="https://github.com/libbpf/libbpf-rs/blob/master/examples/runqslower/README.md">runqslower docs</a></li>
</ul>
<p>If you have more questions / concerns after that, please reach out to me in any way possible.</p>
</body>
</html>
